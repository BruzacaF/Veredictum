<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Julgamento do Processo - Veredictum</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .processo-header {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .voto-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
        
        .voto-badge {
            min-width: 120px;
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .processo-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .processo-item:hover {
            background-color: #e9ecef;
        }
        
        .processo-item.active {
            background-color: #0d6efd;
            color: white;
        }
    </style>
</head>
<body class="bg-light">

<header class="bg-primary text-white shadow-sm mb-4">
    <nav class="container-fluid d-flex justify-content-between align-items-center py-3 px-4">
        <h2 class="h4 mb-0">
            <i class="bi bi-gavel"></i> Reuni√£o <span th:text="${'#' + sessao.id}">0004</span>
        </h2>
        <div class="d-flex align-items-center gap-3">
            <span class="navbar-text text-white">
                Data: <strong th:text="${#temporals.format(sessao.data, 'dd/MM/yyyy')}">06/06/2016</strong>
            </span>
            <span class="navbar-text text-white me-3">
                <i class="bi bi-person-circle"></i>
                <span th:text="${usuario.nome}">Professor</span>
                <span class="badge bg-warning text-dark ms-2" th:if="${ehCoordenador}">
                    <i class="bi bi-star-fill"></i> Coordenador
                </span>
            </span>
            <form method="post" th:action="@{/logout}">
                <button class="btn btn-outline-light btn-sm px-3" type="submit">Sair</button>
            </form>
        </div>
    </nav>
</header>

<div class="container-fluid py-4">
    <div class="row">
        <!-- Pauta -->
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-list-ul"></i> Pauta</h6>
                </div>
                <div class="card-body p-2">
                    <div class="list-group list-group-flush">
                        <a class="list-group-item list-group-item-action p-2 processo-item"
                           th:classappend="${p.id == processo.id ? 'active' : ''}"
                           th:each="p : ${sessao.pauta}"
                           th:href="@{${ehCoordenador ?
                                     '/coordenador/sessao/' + sessao.id + '/processo/' + p.id + '/julgamento' :
                                     '/reuniao/' + sessao.id + '/processo/' + p.id + '/visualizar'}}">
                            <small th:text="${p.numero}">233423400435/18</small>
                            <span class="badge bg-warning text-dark float-end"
                                  th:if="${p.status.name() == 'EM_PAUTA'}"
                                  title="Em Pauta">
                                <i class="bi bi-hourglass-split"></i>
                            </span>
                            <span class="badge bg-info text-dark float-end"
                                  th:if="${p.status.name() == 'EM_JULGAMENTO'}"
                                  title="Em Julgamento">
                                <i class="bi bi-play-fill"></i>
                            </span>
                            <span class="badge bg-success float-end"
                                  th:if="${p.status.name() == 'JULGADO'}"
                                  title="Julgado">
                                <i class="bi bi-check-circle-fill"></i>
                            </span>
                        </a>
                    </div>
                    <button class="btn btn-sm btn-danger w-100 mt-3"
                            disabled
                            th:if="${ehCoordenador}">
                        <i class="bi bi-x-circle"></i> Encerrar reuni√£o
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Processo em Aprecia√ß√£o -->
        <div class="col-md-9">
            <!-- Mensagens -->
            <div class="alert alert-success alert-dismissible fade show" th:if="${success}">
                <i class="bi bi-check-circle"></i> <span th:text="${success}"></span>
                <button class="btn-close" data-bs-dismiss="alert" type="button"></button>
            </div>
            <div class="alert alert-danger alert-dismissible fade show" th:if="${error}">
                <i class="bi bi-exclamation-triangle"></i> <span th:text="${error}"></span>
                <button class="btn-close" data-bs-dismiss="alert" type="button"></button>
            </div>
            
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Processo em aprecia√ß√£o</h5>
                </div>
                <div class="card-body">
                    <div class="processo-header">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <strong>N¬∫:</strong>
                                    <span class="border rounded px-3 py-1 bg-white" th:text="${processo.numero}">233423400435/18</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <strong>Solicitante:</strong>
                                    <span class="border rounded px-3 py-1 bg-white" th:text="${processo.aluno?.nome}">Jos√© Pabro da Silva</span>
                                </p>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <strong>Assunto:</strong>
                                    <span class="border rounded px-3 py-1 bg-white" th:text="${processo.assunto?.nome}">Dispensa de pr√©-requisito</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <strong>Decis√£o do Relator:</strong>
                                    <span class="badge rounded px-3 py-2"
                                          th:classappend="${processo.decisaoRelator?.name() == 'DEFERIMENTO' ? 'bg-success' : 
                                                         processo.decisaoRelator?.name() == 'INDEFERIMENTO' ? 'bg-danger' : 'bg-secondary'}"
                                          th:text="${processo.decisaoRelator != null ? processo.decisaoRelator.name() : 'Sem parecer'}">
                                        INDEFERIMENTO
                                    </span>
                                </p>
                            </div>
                        </div>
                        
                        <!-- Resultado Final (s√≥ aparece quando julgado e tem decis√£o final) -->
                        <div class="row mb-3" th:if="${processo.status.name() == 'JULGADO' && processo.decisaoFinal != null}">
                            <div class="col-12">
                                <div class="alert alert-success border-2 shadow-sm">
                                    <h5 class="alert-heading mb-3">
                                        <i class="bi bi-check-circle-fill"></i> Resultado do Julgamento
                                    </h5>
                                    <p class="mb-0">
                                        <strong>Decis√£o Final:</strong>
                                        <span class="badge fs-5 ms-2 px-4 py-2"
                                              th:classappend="${processo.decisaoFinal.name() == 'DEFERIMENTO' ? 'bg-success' : 'bg-danger'}"
                                              th:text="${processo.decisaoFinal.name()}">
                                            DEFERIMENTO
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-0">
                                    <strong>Relator:</strong>
                                    <span class="border rounded px-3 py-1 bg-white"
                                          th:text="${processo.relator?.nome ?: 'N√£o atribu√≠do'}">Val√©ria Cavalcanti</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-0">
                                    <strong>Parecer:</strong>
                                    <button class="btn btn-sm btn-outline-primary ms-2"
                                            onclick="visualizarParecer()"
                                            th:if="${processo.parecer != null}">
                                        <i class="bi bi-file-earmark-text"></i> Ver parecer
                                    </button>
                                    <span class="text-muted fst-italic ms-2" th:unless="${processo.parecer != null}">
                                        Sem parecer anexado
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Votos -->
                    <h6 class="mt-4 mb-3"><strong><i class="bi bi-hand-thumbs-up"></i> Votos dos Membros</strong></h6>
                    
                    <div class="alert alert-info" th:if="${sessao.membros.isEmpty()}">
                        <i class="bi bi-info-circle"></i> Nenhum membro participante nesta sess√£o.
                    </div>
                    
                    <div th:unless="${sessao.membros.isEmpty()}">
                        <div class="voto-card mb-2 p-2 border rounded" th:each="votoMembro : ${votosMembros}">
                            <div class="row align-items-center">
                                <!-- Coluna do nome -->
                                <div class="col-md-4">
                                    <strong th:text="${votoMembro.membro.nome}">Nome do Professor</strong>
                                    
                                    <span class="badge bg-primary ms-2"
                                          th:if="${votoMembro.membro.id == sessao.coordenador.id}">
                <i class="bi bi-star-fill"></i> Coordenador
            </span>
                                    
                                    <span class="badge bg-info ms-2" th:if="${votoMembro.membro.id == usuario.id}">
                <i class="bi bi-person-check"></i> Voc√™
            </span>
                                </div>
                                
                                <!-- Coluna dos votos / bot√£o -->
                                <div class="col-md-8">
                                    <!-- Bot√µes de voto para coordenador -->
                                    <div class="btn-group" th:if="${votoMembro.membro.id == usuario.id and podeVotar and ehCoordenador}">
                                        <button class="btn btn-sm btn-outline-success" onclick="registrarVoto(this, 'COM_RELATOR')"
                                                th:data-processo-id="${processo.id}"
                                                th:data-reuniao-id="${sessao.id}"
                                                type="button">Aprovar
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="registrarVoto(this, 'DIVERGENTE')"
                                                th:data-processo-id="${processo.id}"
                                                th:data-reuniao-id="${sessao.id}"
                                                type="button">Reprovar
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning" onclick="registrarVoto(this, 'AUSENTE')"
                                                th:data-processo-id="${processo.id}"
                                                th:data-reuniao-id="${sessao.id}"
                                                type="button">Absten√ß√£o
                                        </button>
                                    </div>
                                    
                                    <!-- Bot√µes de voto para membros (n√£o coordenadores) -->
                                    <div class="btn-group" th:if="${votoMembro.membro.id == usuario.id and podeVotar and !ehCoordenador}">
                                        <button class="btn btn-sm btn-outline-success" onclick="registrarVoto(this, 'COM_RELATOR')"
                                                th:data-processo-id="${processo.id}"
                                                th:data-reuniao-id="${sessao.id}"
                                                type="button">
                                            <i class="bi bi-hand-thumbs-up"></i> Com Relator
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="registrarVoto(this, 'DIVERGENTE')"
                                                th:data-processo-id="${processo.id}"
                                                th:data-reuniao-id="${sessao.id}"
                                                type="button">
                                            <i class="bi bi-hand-thumbs-down"></i> Divergente
                                        </button>
                                    </div>
                                    
                                    <!-- Exibi√ß√£o dos votos j√° dados -->
                                    <span class="badge voto-badge"
                                          th:classappend="${votoMembro.voto.voto?.name() == 'COM_RELATOR' ? 'bg-success' :
                                   votoMembro.voto.voto?.name() == 'DIVERGENTE' ? 'bg-danger' :
                                   votoMembro.voto.voto?.name() == 'AUSENTE' ? 'bg-warning text-dark' : 'bg-secondary'}"
                                          th:if="${votoMembro.voto != null}"
                                          th:text="${votoMembro.voto.voto?.name()}">Aguardando</span>
                                    
                                    <span class="badge voto-badge bg-secondary" th:unless="${votoMembro.voto != null}">Aguardando voto</span>
                                    
                                    <small class="text-muted ms-3"
                                           th:if="${votoMembro.voto != null and votoMembro.voto.dataVoto != null}"
                                           th:text="'Votado em: ' + ${#temporals.format(votoMembro.voto.dataVoto, 'dd/MM/yyyy HH:mm')}">
                                    </small>
                                </div>
                            </div>
                        </div>
                    
                    
                    </div>
                    
                    <!-- Bot√£o de Concluir Julgamento - Apenas para Coordenador -->
                    <div class="mt-4" th:if="${ehCoordenador && processo.status.name() == 'EM_JULGAMENTO'}">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Aten√ß√£o:</strong> Ao concluir o julgamento, o resultado ser√° calculado automaticamente. 
                            Membros que n√£o votaram ser√£o marcados como AUSENTE.
                        </div>
                        <button class="btn btn-primary btn-lg w-100" onclick="concluirJulgamento()" type="button">
                            <i class="bi bi-check-circle"></i> Concluir Julgamento e Calcular Resultado
                        </button>
                    </div>
                    
                    <!-- Resultado Final Exibido -->
                    <div class="mt-4" th:if="${processo.status.name() == 'JULGADO' && processo.decisaoFinal != null}">
                        <div class="alert alert-success border-3 shadow">
                            <h5 class="alert-heading">
                                <i class="bi bi-trophy-fill"></i> Julgamento Conclu√≠do
                            </h5>
                            <hr>
                            <p class="mb-0">
                                <strong>Decis√£o Final:</strong>
                                <span class="badge fs-4 ms-2 px-4 py-2"
                                      th:classappend="${processo.decisaoFinal.name() == 'DEFERIMENTO' ? 'bg-success' : 'bg-danger'}"
                                      th:text="${processo.decisaoFinal.name()}">
                                    DEFERIMENTO
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div th:replace="~{layout/footer :: footer}"></div>
                
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
                <script th:if="${ehCoordenador}" th:inline="javascript">
                    const sessaoId = /*[[${sessao.id}]]*/ 0;
                    const processoId = /*[[${processo.id}]]*/ 0;
                    
                    function retirarDePauta() {
                        if (confirm('Tem certeza que deseja retirar este processo da pauta?\n\nEle voltar√° ao status DISTRIBU√çDO.')) {
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = `/coordenador/sessao/${sessaoId}/processo/${processoId}/remover`;
                            
                            const csrfToken = /*[[${_csrf.token}]]*/ '';
                            const csrfInput = document.createElement('input');
                            csrfInput.type = 'hidden';
                            csrfInput.name = '_csrf';
                            csrfInput.value = csrfToken;
                            form.appendChild(csrfInput);
                            
                            document.body.appendChild(form);
                            form.submit();
                        }
                    }
                    
                    function concluirJulgamento() {
        if (confirm('üîî CONFIRMAR CONCLUS√ÉO DO JULGAMENTO\n\n' +
                    '‚úì O resultado ser√° calculado com base nos votos registrados\n' +
                    '‚úì Membros ausentes ser√£o marcados automaticamente\n' +
                    '‚úì Esta a√ß√£o n√£o pode ser desfeita\n\n' +
                    'Deseja prosseguir?')) {
                            form.method = 'POST';
                            form.action = `/coordenador/sessao/${sessaoId}/processo/${processoId}/concluir`;
                            
                            const csrfToken = /*[[${_csrf.token}]]*/ '';
                            const csrfInput = document.createElement('input');
                            csrfInput.type = 'hidden';
                            csrfInput.name = '_csrf';
                            csrfInput.value = csrfToken;
                            form.appendChild(csrfInput);
                            
                            document.body.appendChild(form);
                            form.submit();
                        }
                    }
                    
                    
                    function visualizarParecer() {
                        // TODO: Implementar visualiza√ß√£o do parecer
                        alert('Visualiza√ß√£o de parecer ser√° implementada');
                    }
                </script>
                
                <script th:inline="javascript">
                    // Script para registrar voto (dispon√≠vel para todos os membros)
                    function registrarVoto(button, decisao) {
                        const processoId = button.getAttribute('data-processo-id');
                        const reuniaoId = button.getAttribute('data-reuniao-id');
                        
                        const decisaoTexto = decisao === 'COM_RELATOR' ? 'aprovar' :
                                decisao === 'DIVERGENTE' ? 'reprovar' :
                                        'se abster';
                        
                        
                        if (confirm(`Confirma seu voto para ${decisaoTexto} este processo?`)) {
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = `/reuniao/${reuniaoId}/processo/${processoId}/votar`;
                            
                            const csrfToken = /*[[${_csrf.token}]]*/ '';
                            const csrfInput = document.createElement('input');
                            csrfInput.type = 'hidden';
                            csrfInput.name = '_csrf';
                            csrfInput.value = csrfToken;
                            form.appendChild(csrfInput);
                            
                            const decisaoInput = document.createElement('input');
                            decisaoInput.type = 'hidden';
                            decisaoInput.name = 'decisao';
                            decisaoInput.value = decisao;
                            form.appendChild(decisaoInput);
                            
                            document.body.appendChild(form);
                            form.submit();
                        }
                    }
                </script>
</body>
</html>
