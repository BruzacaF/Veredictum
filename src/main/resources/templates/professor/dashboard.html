<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Dashboard do Aluno</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div th:replace="~{layout/header :: header(usuario=${usuario})}"></div>

<div class="container py-4">

    <!-- Abas -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <button class="nav-link active"
                    data-bs-toggle="tab"
                    data-bs-target="#painel-processos"
                    type="button">
                üìÑ Meus Processos
            </button>
        </li>

        <li class="nav-item">
            <button class="nav-link"
                    data-bs-toggle="tab"
                    data-bs-target="#painel-reunioes"
                    type="button">
                üóìÔ∏è Reuni√µes do Colegiado
            </button>
        </li>
    </ul>

    <!-- Conte√∫do das abas -->
    <div class="tab-content">

        <!-- Painel Processos -->
        <div class="tab-pane fade show active" id="painel-processos">
            <div th:replace="fragments/painel :: painel"></div>
        </div>

        <!-- Painel Reuni√µes -->
        <div class="tab-pane fade" id="painel-reunioes">
            <div th:replace="~{fragments/painel-reuniao :: painel-reuniao}"></div>

        </div>

    </div>

</div>

<div class="modal fade" id="modalProcesso" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Processo</h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body" id="modalProcessoBody"></div>

        </div>
    </div>
</div>

<!-- Modal de Reuni√£o movido para dentro do painel-reuniao -->

<div th:replace="~{layout/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Faz o flash desaparecer ap√≥s 3 segundos
    setTimeout(function() {
        const msg = document.getElementById("flash-message-success");
        const err = document.getElementById("flash-message-error");
        if (msg) msg.style.display = "none";
        if (err) err.style.display = "none";
    }, 3000);


    // PARA TABELA PROCESSOS --------------------------------------------------

    async function carregarTabelaComFiltros(paramsObject) {
        const params = new URLSearchParams(paramsObject).toString();
        try {
            const resp = await fetch('/processo/listar?' + params, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!resp.ok) {
                console.error('Resposta n√£o OK:', resp.status, await resp.text());
                return;
            }

            const html = await resp.text();
            document.getElementById('tabela-container').innerHTML = html;
        } catch (err) {
            console.error('Erro ao carregar tabela via AJAX:', err);
        }
    }

    // quando o bot√£o for clicado, coleta filtros e chama AJAX
    document.getElementById('btnFiltrar').addEventListener('click', function() {
        const assunto = document.getElementById('filtroAssunto').value || '';
        const status = document.getElementById('filtroStatus').value || '';
        const ordenacao = document.getElementById('filtroOrdenacao').value;

        carregarTabelaComFiltros({ assunto, status, ordenacao });

        document.getElementById('filtroOrdenacao').value = ordenacao;
    });

    // -------------------------------------------------- --------------------------------------------------

    // PARA TABELA REUNIOES

    document.addEventListener("DOMContentLoaded", () => {

        const tabReunioes = document.querySelector('[data-bs-target="#painel-reunioes"]');
        const container = document.querySelector("#painel-reunioes");

        if (!tabReunioes || !container) {
            console.warn('Elementos da aba de reuni√µes n√£o encontrados');
            return;
        }

        let carregado = false;

        tabReunioes.addEventListener("shown.bs.tab", () => {
            if (!carregado) {
                carregarReunioes();
                carregado = true;
            }
        });

        function carregarReunioes(params = "") {
            console.log('Carregando reuni√µes com params:', params);
            
            container.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <div class="spinner-border"></div>
                    <div class="mt-2">Carregando reuni√µes...</div>
                </div>
            `;

            fetch(`/reuniao/professor/listar${params}`, {
                method: 'GET',
                headers: {
                    'Accept': 'text/html',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(res => {
                    console.log('Response status:', res.status);
                    if (!res.ok) {
                        return res.text().then(text => {
                            console.error('Response error:', text);
                            throw new Error(`HTTP ${res.status}: ${text}`);
                        });
                    }
                    return res.text();
                })
                .then(html => {
                    console.log('HTML recebido, tamanho:', html.length);
                    container.innerHTML = html;
                })
                .catch(err => {
                    console.error('Erro ao carregar reuni√µes:', err);
                    container.innerHTML = `
                        <div class="alert alert-danger m-3">
                            <h5 class="alert-heading">Erro ao carregar reuni√µes</h5>
                            <p class="mb-0">${err.message}</p>
                            <hr>
                            <small>Verifique o console do navegador para mais detalhes.</small>
                        </div>
                    `;
                });
        }

        document.addEventListener("submit", e => {
            const form = e.target.closest("form[data-form-reunioes]");
            if (form) {
                e.preventDefault();
                const params = new URLSearchParams(new FormData(form)).toString();
                console.log('Filtrando com params:', params);
                carregarReunioes("?" + params);
            }
        });
    });

    // MODAL SCRIPT
    document.addEventListener("DOMContentLoaded", () => {

        const modalEl = document.getElementById("modalProcesso");
        const modalBody = document.getElementById("modalProcessoBody");
        const modal = new bootstrap.Modal(modalEl);

        // Delega√ß√£o de evento para bot√µes gerados dinamicamente
        document.addEventListener("click", async (event) => {

            const btn = event.target.closest(".btn-detalhes");
            if (!btn) return;

            event.preventDefault();

            const id = btn.dataset.id;
            if (!id) return;

            // Feedback imediato
            modalBody.innerHTML = `
                <div class="text-center text-muted py-5">
                    <div class="spinner-border mb-2" role="status"></div>
                    <div>Carregando detalhes do processo...</div>
                </div>
            `;

            modal.show();

            try {
                const resp = await fetch(`/processo/${id}/modal`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!resp.ok) {
                    throw new Error("Erro ao carregar modal");
                }

                const html = await resp.text();
                modalBody.innerHTML = html;

            } catch (e) {
                console.error(e);
                modalBody.innerHTML = `
                    <div class="alert alert-danger small text-center">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        N√£o foi poss√≠vel carregar os dados do processo.
                    </div>
                `;
            }
        });
    });

    // MODAL SCRIPT - Reuni√µes (REMOVIDO - agora redireciona para p√°gina de detalhes)
    document.addEventListener("DOMContentLoaded", () => {
        document.addEventListener("click", event => {
            const btn = event.target.closest(".btn-detalhes-reuniao");
            if (!btn) return;

            event.preventDefault();

            const id = btn.dataset.id;
            if (!id) return;

            // Redirecionar para a p√°gina de detalhes
            window.location.href = `/reuniao/${id}/detalhes`;
        });
    });

    // FUN√á√ÉO DE VOTA√á√ÉO
    function registrarVoto(button, tipoDecisao) {
        const processoId = button.dataset.processoId;
        const justificativa = document.getElementById('justificativaVoto')?.value || '';
        
        // Criar formul√°rio e submeter
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/home/professor/processo/${processoId}/votar`;
        
        // Adicionar token CSRF
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
        
        if (csrfToken) {
            const inputCsrf = document.createElement('input');
            inputCsrf.type = 'hidden';
            inputCsrf.name = '_csrf';
            inputCsrf.value = csrfToken;
            form.appendChild(inputCsrf);
        }
        
        const inputTipo = document.createElement('input');
        inputTipo.type = 'hidden';
        inputTipo.name = 'tipoDecisao';
        inputTipo.value = tipoDecisao;
        form.appendChild(inputTipo);
        
        if (justificativa) {
            const inputJust = document.createElement('input');
            inputJust.type = 'hidden';
            inputJust.name = 'justificativa';
            inputJust.value = justificativa;
            form.appendChild(inputJust);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
</script>

</body>
</html>

