<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <title>Dashboard do Aluno</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<!-- Header Fragment -->
<div th:replace="~{layout/header :: header(usuario=${usuario})}"></div>

<div class="container py-4">
    <div th:replace="~{fragments/form-processo :: form-processo(usuario=${usuario}, assuntos=${assuntos}, processoDTO=${processoDTO})}"></div>

    <form id="form-filtros" class="row g-3 mb-3">
        <div class="col-md-4">
            <label class="form-label">Buscar por Assunto</label>
            <select class="form-select" id="filtroAssunto" name="assunto">
                <option value="">Todos</option>
                <option th:each="assunto : ${assuntos}" th:value="${assunto.nome}" th:text="${assunto.nome}"></option>
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">Filtrar por Status</label>
            <select class="form-select" id="filtroStatus" name="status">
                <option value="">Todos</option>
                <option th:each="st : ${status}" th:value="${st}" th:text="${st}"></option>
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label" for="filtroOrdenacao">Ordenar por Data</label>
            <select class="form-select" id="filtroOrdenacao" name="ordenacao">
                <option value="ASC">Mais Antigos</option>
                <option value="DESC" selected>Mais Recentes</option>
            </select>
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <button id="btnFiltrar" class="btn btn-secondary w-100" type="button">Filtrar</button>
        </div>
    </form>
    <!-- Componente Tabela -->
    <div id="tabela-container">
        <div th:replace="~{fragments/tabela-processo :: tabela-processo(processos=${processos}, status=${status}, assuntos=${assuntos})}"></div>
    </div>

</div>

<!-- Footer Fragment -->
<div th:replace="~{layout/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Faz o flash desaparecer após 3 segundos
    setTimeout(function() {
        const msg = document.getElementById("flash-message-success");
        const err = document.getElementById("flash-message-error");
        if (msg) msg.style.display = "none";
        if (err) err.style.display = "none";
    }, 3000);

    async function carregarTabelaComFiltros(paramsObject) {
        const params = new URLSearchParams(paramsObject).toString();
        try {
            const resp = await fetch('/processo/listar?' + params, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!resp.ok) {
                console.error('Resposta não OK:', resp.status, await resp.text());
                return;
            }

            const html = await resp.text();
            document.getElementById('tabela-container').innerHTML = html;
        } catch (err) {
            console.error('Erro ao carregar tabela via AJAX:', err);
        }
    }

    // quando o botão for clicado, coleta filtros e chama AJAX
    document.getElementById('btnFiltrar').addEventListener('click', function() {
        const assunto = document.getElementById('filtroAssunto').value || '';
        const status = document.getElementById('filtroStatus').value || '';
        const ordenacao = document.getElementById('filtroOrdenacao').value;

        carregarTabelaComFiltros({ assunto, status, ordenacao });

        document.getElementById('filtroOrdenacao').value = ordenacao;
    });


</script>

</body>
</html>
